<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>子站点</title>
		<link rel="icon" href="../img/logo2.ico" type="img/x-ico" />
		<link rel="stylesheet" href="../css/iconfont.css">
		<link rel="stylesheet" href="../css/loading.css">
		<link rel="stylesheet" href="../css/navHead.css">

		<link rel="stylesheet" href="../css/pagination.css" />

		<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
		<script type="text/javascript" src="../js/jquery.easing.1.3.js"></script>
		<script type="text/javascript" src="../js/jquery.kwicks-1.5.1.pack.js"></script>

		<script type="text/javascript" src="../js/config.js"></script>
		<script type="text/javascript" src="../js/vue.min.js"></script>

		<script type="text/javascript" src="../js/jquery.pagination.js"></script>
		<script type="text/javascript" src="../js/exif.js"></script>

		<script type="text/javascript">
			$(function() {
				$('.nav').kwicks({
					max: 120,
					isVertical: false,
					sticky: false,
					defaultKwick: 0,
					event: 'mouseover',
					spacing: 0,
					duration: 500
				});
			});

			function selectNav(index) {
				$("#navBar1").removeClass("on");
				$("#navBar2").removeClass("on");
				$("#navBar3").removeClass("on");
				$("#navBar4").removeClass("on");
				$("#navBar5").removeClass("on");
				$("#navBar6").removeClass("on");

				var idStr = "#navBar" + index;
				$(idStr).addClass("on");
				if(index == '1'){
					window.location.replace('siteList.html');
				}else if(index == '2'){
					window.location.replace('driverList.html');
				}else if(index == '3'){
					window.location.replace('masterList.html');
				}else if(index == '4'){
					window.location.replace('childSiteList.html');
				}else if(index == '5'){
					window.location.replace('userList.html');
				}else if(index == '6'){
					window.location.replace('mapList.html');
				}
			}
		</script>
	</head>

	<body>
		<div id="headerDiv" class="header" hidden> 
			<div class="logoDiv"></div>
			<ul class="nav">
				<li id="siteListNav">
					<a id="navBar1" href="javascript:selectNav('1')">站点列表</a>
				</li>
				<li id="driverListNav">
					<a id="navBar2" href="javascript:selectNav('2')">司机列表</a>
				</li>
				<li id="masterListNav">
					<a id="navBar3" href="javascript:selectNav('3')">货源方列表</a>
				</li>
				<li id="childSiteListNav">
					<a id="navBar4" class="on" href="javascript:selectNav('4')">子站点</a>
				</li>
				
				<li id="userListNav">
					<a id="navBar5" href="javascript:selectNav('5')">人员管理</a>
				</li>
				<li id="mapListNav">
					<a id="navBar6" href="javascript:selectNav('6')">地图展示</a>
				</li>

			</ul>
		</div>
		<div id="app" class="content" hidden>
			<div class="oprationToolBar">
				<div class="filterDiv">
					<div class="nameFilterDiv">
						<div class="filterKeyDiv">站点名称</div>
						<div class="filterValueDiv">
							<input v-model="filterSiteName" class="filterValueInput" type="text" placeholder="" title="站点名称">
						</div>
					</div>
					<div class="nameFilterDiv">
						<div class="filterKeyDiv">法人姓名</div>
						<div class="filterValueDiv">
							<input v-model="filterLawsManName" class="filterValueInput" type="text" placeholder="" title="法人姓名">
						</div>
					</div>

					<div class="nameFilterDiv" style="width: 400px;">
						<div class="filterKeyDiv">创建时间</div>
						<div class="filterValueDiv">
							<input v-model="filterBeginTime" style="width: 135px;" class="filterValueInput" type="date" placeholder="" title="法人姓名">
						</div>
						<div style="float:left;line-height: 50px;width: 30px;text-align: center;">至</div>
						<div class="filterValueDiv">
							<input v-model="filterEndTime" style="width: 135px;" class="filterValueInput" type="date" placeholder="" title="法人姓名">
						</div>

					</div>

					<div class="filterOperateBtnDiv">
						<div id="query_btn" class="filterOperateDiv">
							<input type="button" class="filterOperateBtn" value="查询" />
							<i class="iconfont" style="font-size: 20px; margin-top: 15px;">&#xe60e;</i>
						</div>
						<div id="clear_btn" class="filterOperateDiv">
							<input type="button" class="filterOperateBtn" value="清空" />
							<i class="iconfont">&#xe630;</i>
						</div>

					</div>

				</div>
				
				<div id="add_btn" class="addDiv">
					<input type="button" class="colorBtn" value="新建">
					<i class="iconfont">&#xe636;</i>
				</div>
			</div>
			<div class="bigContent">
				<div class="listContent">
					<table class="hovertable" title="">
						<thead>
							<tr>
								<th>#</th>
								<th>站点名称</th>
								<th>站点类型</th>
								<th>地址</th>
								<th>审核状态</th>
								<th>法人姓名</th>
								<th>提成率</th>
								<th>注册时间</th>
								<th>更新时间</th>
								<th>操作</th>
							</tr>

						</thead>

						<tr v-for="item in datalist" @click="openItemDetailPage(item.siteId)" onmouseover="this.style.backgroundColor='#ffff66';" onmouseout="this.style.backgroundColor='#d4e3e5';">
							<td>{{item.id}}</td>
							<td>{{item.siteName}}</td>
							<td>{{item.siteType == 1 ? "一级站点" : "子站点"}}</td>
							<td>{{item.siteProvinceName}}{{item.siteCityName}}{{item.address}}</td>
							<td>{{judgeStatus(item.siteCheckStatus)}}</td>
							<td>{{item.lawsManName}}</td>
							<td>{{item.childToSuperRate}}</td>
							<td>{{datetransform(item.createTime)}}</td>
							<td>{{datetransform(item.updateTime)}}</td>
							<td>
								<div class="oprateDiv">
									<a @click="editItem(item.id,$event)">编辑</a>
									<a @click="deleteItem(item.id,$event)">删除</a>
								</div>

							</td>

						</tr>

					</table>
				</div>
				<div class="hrDiv"></div>
				<div class="countDiv">
					<div class="f-l hejiDiv">合计</div>
					<div class="f-l julushuDiv">记录数：</div>
					<div class="f-l jiluCountDiv">{{itemCount}}</div>
				</div>
				<div class="pages">
					<div id="Pagination"></div>
					<div class="searchPage">
						<span class="page-sum">共<strong class="allPage">1</strong>页</span>
						<span class="page-go">跳转<input type="text">页</span>
						<a href="javascript:;" class="page-btn">GO</a>
					</div>
				</div>
			</div>
			
			<div id="addBigDiv" class="i none">
				<div class="addContentDiv">
					<div class="topBarDiv">
						<i class="iconfont">&#xe608;</i>
						<div class="titleDiv">新建子站点</div>
						<div class="closeDiv">
							<i id="closeBtn" onclick="closeAddPage()" class="iconfont">&#xe607;</i>
						</div>
					</div>

					<div class="addPageLineDiv" style="margin-top: 20px;">
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">站点名称</div>
							<input v-model="siteName" class="valueInput" type="text" placeholder="例：陕西西安站" title="站点名称">
						</div>
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">营业执照号</div>
							<input v-model="businessLicenseNumber" class="valueInput" type="text" placeholder="" title="营业执照号">
						</div>
					</div>

					<div class="addPageLineDiv">
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">省份、城市</div>
							<select class="citySelect" onchange="selectprovince(this)" id="selectprovince">
								<option v-for="item in province" :value="item.id">{{item.name}}</option>
							</select>
							<select class="citySelect" id="selectcity">
								<option value="">请选择</option>
								<option v-for="item in nowcity" :value="item.id">{{item.name}}</option>
							</select>

						</div>
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">详细地址</div>
							<input v-model="address" class="valueInput" type="text" placeholder="从区开始写" title="法人身份证号">
						</div>
					</div>

					<div class="addPageLineDiv">
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">法人姓名</div>
							<input v-model="lawsManName" class="valueInput" type="text" placeholder="" title="法人姓名">
						</div>
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">法人身份证号</div>
							<input v-model="lawsManIdCardNumber" class="valueInput" type="text" placeholder="" title="法人身份证号">
						</div>
					</div>

					<div class="addPageLineDiv">
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">法人手机号</div>
							<input v-model="lawsManPhone" class="valueInput" type="text" placeholder="请输入手机号" title="法人手机号">
						</div>
						
						<div class="addPageLineSmallDiv">
							<div class="keyDiv">父站点提成率</div>
							<input v-model="childToSuperRate" class="valueInput" type="text" placeholder="例:0.05  代表每单父站点提成5% " title="父站点提成率">
						</div>
					</div>
					<div class="photoLineDiv">
						<div class="photoItemDiv f-l">
							<div class="photoTitle">
								营业执照
							</div>
							<div class="photoPhotoDiv">
								<img id="zhizhaoImg" src="../img/zhaoxiang.png" onclick="chooseImg1()" />
								<input id="ip_zhizhao" class="fr compile-pic" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple hidden="true" onchange="uploadYingYe(this)">
							</div>
						</div>

						<div class="photoarea f-l">
							<div class="photoAreaTitle">
								场地租赁合同或土地证照片
							</div>
							<div class="show-pic fl">
								<ul id="showul">
									<li id="xz" class='fl'>
										<div>
											<img class="showBigImg" src="../img/zhaoxiang.png" onclick="chooseImg2()" />
											<input id="ip_tudiHetong" class="fr compile-pic" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple hidden="true" onchange="uploadHeTong(this)">
										</div>

									</li>
								</ul>
							</div>

						</div>

					</div>

					<div class="operateBarDiv">
						<div class="hrDiv" style="margin: 0px;"></div>
						<div onclick="closeAddPage()" class="operateDiv">
							<input type="button" class="colorBtn" style="background: gray;" value="取消" />
							<i class="iconfont">&#xe664;</i>
						</div>
						<div id="save_btn" class="operateDiv">
							<input type="button" class="colorBtn" value="保存" />
							<i class="iconfont">&#xe611;</i>
						</div>
					</div>
				</div>

			</div>

			<div id="show_img" class="i none">
				<img class="i1 sel cursor-pointer" src="../img/ic_close.png" onclick="$('#show_img').addClass('none')" />
				<img class="i2" style="margin: auto;max-width: 80%;max-height: 80%;" src="" />
				<img class="i3 sel cursor-pointer" src="../img/ic_left.png" onclick="switchImg(-1)" />
				<img class="i4 sel cursor-pointer" src="../img/ic_right.png" onclick="switchImg(1)" />
			</div>

			<div id="show_alone_img" class="i none">
				<img class="i1 sel cursor-pointer" src="../img/ic_close.png" onclick="$('#show_alone_img').addClass('none')" />
				<img class="i2" src="" />
			</div>
		</div>
	</body>
	
	<script>
		var province;
		var city;
		var nowcity;
		getCity(function(p, c) {
			province = p;
			city = c;
			nowcity = city['1'];
			if(this.obj) {
				selectProvinceAndCity();
			}
		});

		var vm = new Vue({
			el: '#app',
			data: {
				isEdit: 0,
				siteId: '',//编辑时候用
				province: province,
				city: city,
				nowcity: nowcity,
				page: 0,
				pageSize: 15,
				itemCount: 0,
				datalist: [],
				lifePhotoImg: '',
				heTongImageArray: [],
				siteName: '',
				businessLicenseNumber: '',
				lawsManName: '',
				lawsManIdCardNumber: '',
				lawsManPhone: '',
				childToSuperRate: '',
				address: '',
				filterSiteName: '',
				filterLawsManName: '',
				filterBeginTime: '',
				filterEndTime: '',

			},
			methods: {

			}
		})
		
		if(sessionStorage.userType == '0') {
			var removeLi = document.getElementById('childSiteListNav');
			$(removeLi).remove();
		} else if(sessionStorage.userType == '1') {
			var removeLi = document.getElementById('childSiteListNav');
			$(removeLi).remove();

			removeLi = document.getElementById('userListNav');
			$(removeLi).remove();
		} else if(sessionStorage.userType == '3') {
			var removeLi = document.getElementById('siteListNav');
			$(removeLi).remove();
			if(sessionStorage.siteType == '2') {
				removeLi = document.getElementById('childSiteListNav');
				$(removeLi).remove();
			}
		}else if(sessionStorage.userType == '4') {
			var removeLi = document.getElementById('siteListNav');
			$(removeLi).remove();
			
			removeLi = document.getElementById('userListNav');
			$(removeLi).remove();
			
			if(sessionStorage.siteType == '2') {
				removeLi = document.getElementById('childSiteListNav');
				$(removeLi).remove();
			}
		}
		
		$('#headerDiv').show();


		function loadData() {
			$("#Pagination").empty();
			postRegular('getSiteList', {
				page: vm.page,
				rows: vm.pageSize,
				filterSiteName: vm.filterSiteName,
				filterLawsManName: vm.filterLawsManName,
				filterBeginTime: vm.filterBeginTime,
				filterEndTime: vm.filterEndTime,
				superSiteId: sessionStorage.belongSiteId
			}, function(data) {
				$('#app').show();
				vm.datalist = data.object.siteList;
				for(var i = 0; i < vm.datalist.length; i++) {
					var obj = vm.datalist[i];
					obj.id = i + 1;
				}
				vm.itemCount = data.object.siteCount;
				$('.allPage').html(Math.ceil(data.object.siteCount / vm.pageSize));
				$("#Pagination").pagination(data.object.siteCount / vm.pageSize, {
					callback: function(page) { // 回调函数
						vm.page = page;
						loadPageData();
					}
				});
			}, function() {

			})
		}
		loadData();

		function loadPageData() {
			postRegular('getSiteList', {
				page: vm.page,
				rows: vm.pageSize,
				filterSiteName: vm.filterSiteName,
				filterLawsManName: vm.filterLawsManName,
				filterBeginTime: vm.filterBeginTime,
				filterEndTime: vm.filterEndTime,
				superSiteId: sessionStorage.belongSiteId
			}, function(data) {
				vm.datalist = data.object.siteList;
				for(var i = 0; i < vm.datalist.length; i++) {
					var obj = vm.datalist[i];
					obj.id = i + 1;
				}
			})
		}

		//筛选确认
		$('#query_btn').click(function() {
			vm.page = 0;
			loadData();
		})

		//筛选清空
		$('#clear_btn').click(function() {
			vm.filterSiteName = '';
			vm.filterLawsManName = '';
			vm.filterBeginTime = '';
			vm.filterEndTime = '';
			loadData();

		})

		//保存
		$('#save_btn').click(function() {
			if(vm.siteName.length == 0) {
				myAlert("站点名称不能为空！");
				return;
			}

			if(vm.businessLicenseNumber.length == 0) {
				myAlert("营业执照号不能为空！");
				return;
			}

			if($("#selectcity").val().length == 0) {
				myAlert("城市不能为空！");
				return;
			}

			if(vm.address.length == 0) {
				myAlert("详细地址不能为空！");
				return;
			}

			if(vm.lawsManName.length == 0) {
				myAlert("法人姓名不能为空！");
				return;
			}

			if(vm.lawsManIdCardNumber.length == 0) {
				myAlert("法人身份证号不能为空！");
				return;
			}

			if(vm.lawsManPhone.length == 0) {
				myAlert("法人电话不能为空！");
				return;
			}
			
			if(vm.childToSuperRate.length == 0) {
				myAlert("父站点提成率不能为空！");
				return;
			}
			
			
			if(!checkTel(vm.lawsManPhone)) {
				myAlert("法人电话号格式不正确!");
				return;
			}
			

			if(vm.lifePhotoImg.length == 0) {
				myAlert("营业执照照片未上传！");
				return;
			}

			if(vm.heTongImageArray.length == 0) {
				myAlert("场地租赁合同或土地证照片未上传！");
				return;
			}

			var contractPhotos = vm.heTongImageArray.join(',');

			if(vm.isEdit == 0) {
				postRegular('addSite', {
					siteName: vm.siteName,
					superSiteId: sessionStorage.belongSiteId,
					businessLicenseNumber: vm.businessLicenseNumber,
					businessLicensePhoto: vm.lifePhotoImg,
					lawsManName: vm.lawsManName,
					lawsManIdCardNumber: vm.lawsManIdCardNumber,
					lawsManPhone: vm.lawsManPhone,
					childToSuperRate: vm.childToSuperRate,
					leaseContractPhoto: contractPhotos,
					siteProvince: $("#selectprovince").val(),
					siteCity: $("#selectcity").val(),
					address: vm.address,
					siteType: '2',
				}, function(data) {
					closeAddPage();
					window.location.reload();

				}, function() {

				});
			} else if(vm.isEdit == 1) {
				postRegular('editSite', {
					siteId: vm.siteId,
					siteName: vm.siteName,
					businessLicenseNumber: vm.businessLicenseNumber,
					businessLicensePhoto: vm.lifePhotoImg,
					lawsManName: vm.lawsManName,
					lawsManIdCardNumber: vm.lawsManIdCardNumber,
					lawsManPhone: vm.lawsManPhone,
					childToSuperRate: vm.childToSuperRate,
					leaseContractPhoto: contractPhotos,
					siteProvince: $("#selectprovince").val(),
					siteCity: $("#selectcity").val(),
					address: vm.address,
				}, function(data) {
					closeAddPage();
					window.location.reload();

				}, function() {

				});
			}

		})

		//编辑
		function editItem(itemIndex,$event) {
			
			 $event.stopPropagation();
			vm.isEdit = 1;

			var obj = vm.datalist[itemIndex - 1];
			vm.siteId = obj.siteId;
			vm.lifePhotoImg = obj.businessLicensePhoto;
			vm.siteName = obj.siteName;
			vm.businessLicenseNumber = obj.businessLicenseNumber;
			vm.lawsManName = obj.lawsManName;
			vm.lawsManIdCardNumber = obj.lawsManIdCardNumber;
			vm.lawsManPhone = obj.lawsManPhone;
			vm.childToSuperRate = obj.childToSuperRate;
			vm.address = obj.address;
			$("#selectprovince").val(obj.siteProvince);
			vm.nowcity = city[obj.siteProvince];

			setTimeout(function() {
				$("#selectcity").val(obj.siteCity);
			}, 50);

			if(obj.leaseContractPhoto.length > 0) {
				vm.heTongImageArray = obj.leaseContractPhoto.split(',');
				for(var i = 0; i < vm.heTongImageArray.length; i++) {
					var str = vm.heTongImageArray[i];
					$("#xz").before(
						"<li class='fl'>" +
						"<div class='muteImgDiv'>" +
						"<img class='showBigImg' onclick='showimg(this)' src='" + ip + str + "'/>" +
						"<input type='hidden' name='yinyezhihao' value=''/>" +
						"<div id='" + str + "' class='delet-pic' onclick='removeLi(this)'>" +
						"<img src='../img/9E9E7268-4F63-4B93-8850-DFF862172AEA@2x.png' />" +
						"</div>" +
						"</div>" +
						"</li>");

				}
			} else {
				vm.heTongImageArray = [];
			}

			if(vm.lifePhotoImg.length > 0) {
				$('#zhizhaoImg').attr('src', ip + vm.lifePhotoImg);
			}

			$('#addBigDiv').removeClass("none");
		}

		//删除
		function deleteItem(itemIndex,$event) {
			 $event.stopPropagation();
			var obj = vm.datalist[itemIndex - 1];
			console.log(obj.siteName);
			if(window.confirm('你确定要删除 ' + obj.siteName + ' 吗？')) {
				postRegular('deleteSite', {
					siteId: obj.siteId,
				}, function(data) {
					loadPageData();
					myAlert("刪除成功！");
				}, function() {

				});
			} else {

			}
		}

		//添加
		$('#add_btn').click(function() {
			$('#addBigDiv').removeClass("none");
		})

		//关闭
		function closeAddPage() {
			$('#addBigDiv').addClass("none");
			vm.isEdit = 0;
			vm.siteId = '';
			vm.lifePhotoImg = '';

			vm.siteName = '';
			vm.businessLicenseNumber = '';
			vm.lawsManName = '';
			vm.lawsManIdCardNumber = '';
			vm.lawsManPhone = '';
			vm.address = '';
			vm.childToSuperRate = '';
			$('#selectcity').val('');
			$('#selectprovince').val('1');
			$('#zhizhaoImg').attr('src', '../img/zhaoxiang.png');
			for(var i = 0; i < vm.heTongImageArray.length; i++) {
				var removeDiv = document.getElementById(vm.heTongImageArray[i]);
				$(removeDiv).parent().parent().remove();
			}

			vm.heTongImageArray = [];

		}

		//点击查看详情
		function openItemDetailPage(siteId) {
			window.open("siteDetail.html?siteId=" + siteId);
		}

		function selectprovince(obj) {
			vm.nowcity = vm.city[obj.value];
			$('#selectcity').val('');
		}

		function chooseImg1() {
			$('#ip_zhizhao').click();
		}

		function chooseImg2() {
			$('#ip_tudiHetong').click();
		}

		function uploadYingYe(input) {
			var files = input.files;
			var file = files[0];
			var imageType = /^image\//;
			if(!imageType.test(file.type)) {
				myAlert("请选择图片类型上传");
				return;
			}

			var Orientation = null;
			//获取照片方向角属性，用户旋转控制  
			EXIF.getData(file, function() {
				EXIF.getAllTags(this);
				Orientation = EXIF.getTag(this, 'Orientation');
			});

			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function(e) {
				dealImage(e.target.result, {
					quality: 0.1
				}, function(value) {
					managerotateImg(value, Orientation, function(base64) {
						$('#zhizhaoImg').attr('src', base64);
						postRegular('uploadImage', {
							"imgStr": base64.split(",")[1]
						}, function(data) {
							vm.lifePhotoImg = data.object;
						})
					})
				});
			};
		}

		function uploadHeTong(input) {
			var files = input.files;
			for(var i = 0; i < files.length; i++) { //预览新添加的图片
				var file = files[i];
				var imageType = /^image\//;
				if(!imageType.test(file.type)) {
					myAlert("请选择图片类型上传");
					continue;
				}
				var reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = function(e) {
					dealImage(e.target.result, {
						quality: 0.1
					}, function(value) {
						postRegular('uploadImage', {
							"imgStr": value.split(",")[1]
						}, function(data) {
							$("#xz").before(
								"<li class='fl'>" +
								"<div class='muteImgDiv'>" +
								"<img class='showBigImg' onclick='showimg(this)' src='" + ip + data.object + "'/>" +
								"<input type='hidden' name='yinyezhihao' value=''/>" +
								"<div id='" + data.object + "' class='delet-pic' onclick='removeLi(this)'>" +
								"<img src='../img/9E9E7268-4F63-4B93-8850-DFF862172AEA@2x.png' />" +
								"</div>" +
								"</div>" +
								"</li>");
							vm.heTongImageArray.push(data.object);
						})
					});
				};
			}
		}

		function removeLi(obj) {
			$(obj).parent().parent().remove();

			vm.heTongImageArray.remove(obj.id);
		}

		function showimg(obj) {
			index = $(obj).parent().parent().index();
			var src = ip + vm.heTongImageArray[index];
			$('#show_img').removeClass('none');
			$('#show_img .i2').attr('src', src);
		}

		function switchImg(num) {
			index += num;
			var src;
			if(index < 0) {
				index = vm.heTongImageArray.length - 1;
			} else if(index >= vm.heTongImageArray.length) {
				index = 0;
			}
			src = ip + vm.heTongImageArray[index];
			$('#show_img .i2').attr('src', src);
		}

		
	</script>

</html>